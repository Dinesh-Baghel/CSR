@page "/changepassword"
@using System.Security.Claims
@using EmailService.Models
@layout BlankLayout
@attribute [Authorize]

<MudPaper Class="pa-6 mx-auto" MaxWidth="500px" Elevation="4">
    <MudText Typo="Typo.h5" Class="mb-4">Change Password</MudText>

    <MudForm @ref="_form" ValidationMode="ValidationMode.Immediate">
        <!-- Current Password -->
        <MudTextField @bind-Value="Model.CurrentPassword"
                      Label="Current Password"
                      InputType="@(_showCurrent? InputType.Text: InputType.Password)"
                      Required="true"
                      RequiredError="Current password is required"
                      Adornment="Adornment.End"
                      AdornmentIcon="@(_showCurrent? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff)"
                      OnAdornmentClick="() => _showCurrent = !_showCurrent" />

        <!-- New Password -->
        <MudTextField @bind-Value="Model.NewPassword"
                      Label="New Password"
                      InputType="@(_showNew? InputType.Text: InputType.Password)"
                      Required="true"
                      Immediate="true"
                      OnInput="Revalidate"
                      RequiredError="New password is required"
                      Adornment="Adornment.End"
                      AdornmentIcon="@(_showNew? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff)"
                      OnAdornmentClick="() => _showNew = !_showNew"
                      HelperText="Minimum 8 chars, uppercase, lowercase, number, special character"
                      For="@(() => Model.NewPassword)"
                      Validation="ValidatePassword" />

        <!-- Confirm Password -->
        <MudTextField @bind-Value="Model.ConfirmPassword"
                      Label="Confirm Password"
                      InputType="@(_showConfirm? InputType.Text: InputType.Password)"
                      Required="true"
                      Immediate="true"
                      OnInput="Revalidate"
                      RequiredError="Please confirm password"
                      Adornment="Adornment.End"
                      AdornmentIcon="@(_showConfirm? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff)"
                      OnAdornmentClick="() => _showConfirm = !_showConfirm"
                      For="@(() => Model.ConfirmPassword)"
                      Validation="ValidateConfirmPassword" />


        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   Class="mt-4"
                   Disabled="@(!_formValid)"
                   OnClick="ChangePWD">
            Change Password
        </MudButton>

    </MudForm>
</MudPaper>

@code {

    private MudForm? _form;
    private bool _formValid;

    private bool _showCurrent;
    private bool _showNew;
    private bool _showConfirm;
    private string VendorCode = string.Empty;
    public Vendor _vendor { get; set; } = new();
    private ChangePasswordModel Model = new();

    protected override void OnInitialized()
    {

        var user = HttpContextAccessor.HttpContext?.User;

        if (user?.Identity?.IsAuthenticated == true)
        {
            VendorCode = user.Claims.FirstOrDefault(c => c.Type == ClaimTypes.NameIdentifier)?.Value;
        }
        base.OnInitialized();
    }

    private async Task Revalidate()
    {
        if (_form != null)
        {
            await _form.Validate();
            _formValid = _form.IsValid;
            StateHasChanged();
        }
    }
    // Password Policy Validation
    private string ValidatePassword(string password)
    {
        if (string.IsNullOrWhiteSpace(password))
            return "Password is required";

        if (password.Length < 8)
            return "Password must be at least 8 characters";

        if (!password.Any(char.IsUpper))
            return "Password must contain an uppercase letter";

        if (!password.Any(char.IsLower))
            return "Password must contain a lowercase letter";

        if (!password.Any(char.IsDigit))
            return "Password must contain a digit";

        if (!password.Any(ch => "!@#$%^&*()_+-=[]{}|;:'\",.<>/?".Contains(ch)))
            return "Password must contain a special character";
        if (!string.IsNullOrEmpty(Model.ConfirmPassword))
        {
            if (Model.ConfirmPassword != password)
            {
                _formValid = false;
                return "Passwords do not match with confirm password.";
            }
            else
            {
                _formValid = true;
            }

        }

        return null;
    }

    // Confirm Password Validation
    private string ValidateConfirmPassword(string confirm)
    {
        if (confirm != Model.NewPassword)
        {
            _formValid = false;
            return "Passwords do not match";
        }


        _formValid = true;
        return null;

    }

    private async void ChangePWD()
    {

        var selectRequest = new SelectListReq
        {
            Id = 0,
            Cmd = CmdNames.Get_Vendor_By_Code,
            ResponseType = "",
            StrField = VendorCode     // null-safe
        };

        var existingVendor = await ApiMasterService.CallingAPI<GetVendorByCode, SelectListReq>(AllApiNames.GET_VENDOR_BY_CODE, selectRequest);

        if (existingVendor.responseCode == 0 && existingVendor.responseMessage!.ToUpper() == "SUCCESS")
        {
            if (!string.IsNullOrEmpty(existingVendor.VendorModel.VENDOR_CODE))
            {
                selectRequest.Id = existingVendor.VendorModel.VENDOR_ID;
                selectRequest.Cmd = CmdNames.Get_Vendor_Address;
                _vendor = mapper.Map<Vendor>(existingVendor.VendorModel);
                _vendor.VendorGUId = Guid.NewGuid();
                _vendor.VendorAddresses.Clear();
                foreach (var addrss in existingVendor.VendorAddressList)
                {
                    _vendor.VendorAddresses.Add(mapper.Map<VendorAddressDetail>(addrss));
                }

                _vendor.PassWord = _passwordHasher.HashPassword(Model.NewPassword);
                _vendor.Default_Password_Changed = true;

                var res1 = await ApiMasterService.CallingAPI<GenRes, Vendor>(AllApiNames.SET_VENDOR!, _vendor);
                if (res1.responseCode.Equals(0))
                {
                    _vendor = new();
                    Snackbar.Add("Your password has been changed successfully!", Severity.Success);
                    await Task.Delay(1000);
                    //NavigationManager.NavigateTo("/VendorDashboard");
                    NavigationManager.NavigateTo("/Account/Login", forceLoad: true);
                }
                return;
            }
        }
    }

    public class ChangePasswordModel
    {
        public string CurrentPassword { get; set; }
        public string NewPassword { get; set; }
        public string ConfirmPassword { get; set; }
    }

    private void BacktoLogin(MouseEventArgs args)
    {
        throw new NotImplementedException();
    }
}
